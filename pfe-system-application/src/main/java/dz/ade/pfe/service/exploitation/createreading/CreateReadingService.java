package dz.ade.pfe.service.exploitation.createreading;

import dz.ade.pfe.domain.ouvrage.ExploitationReading;
import dz.ade.pfe.domain.ouvrage.Ouvrage;
import dz.ade.pfe.domain.ouvrage.WorkStopTimes;
import dz.ade.pfe.port.in.exploitation.CreateReadingCommand;
import dz.ade.pfe.port.out.exploitation.checkreading.CheckReading;
import dz.ade.pfe.port.out.exploitation.savereading.SaveReading;
import dz.ade.pfe.port.out.exploitation.savereading.SaveWorkTime;
import dz.ade.pfe.port.out.ouvrage.getouvrage.LoadOuvrage;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.ArrayList;
import java.util.List;
import java.util.stream.Collectors;

@Service
@RequiredArgsConstructor
public class CreateReadingService implements CreateReadingCommand {
    private final ReadingMapper readingMapper;
    private final TimeMapper timeMapper;
    private final SaveReading saveReading;
    private final SaveWorkTime saveWorkTime;
    private final LoadOuvrage loadOuvrage;
    private final CheckReading checkReading;

    @Transactional
    @Override
    public boolean createReading(ReadingSaveDto reading, List<TimeDto> times, String code) {
        if(checkReading.exist(reading.getDate(),code).isPresent())
            throw new RuntimeException();
        Ouvrage ouvrage = loadOuvrage.getOuvrage(code);
        ExploitationReading reading1 = readingMapper.ReadingDtoToExpReading(reading);
        reading1.setOuvrage(ouvrage);
        ExploitationReading  reading2 = saveReading.saveReading(reading1);
        List<WorkStopTimes> times1 = timeMapper.TimeMapperToWorkTime(times);
        List<WorkStopTimes> times2 = new ArrayList() ;
        if (times1 != null) {
         times2 =   times1.stream().map((time)->{
                time.setOuvrage(ouvrage);
                time.setReading(reading2);
                return time;
            }).collect(Collectors.toList());
        }
        saveWorkTime.saveWorkStopTime(times2);
        return true;
    }
}
