package dz.ade.pfe.service.exploitation.updatepersonnel;

import dz.ade.pfe.admin.security.user.UserComponent;
import dz.ade.pfe.domain.admin.User;
import dz.ade.pfe.domain.ouvrage.ExploitationUser;
import dz.ade.pfe.domain.ouvrage.Ouvrage;
import dz.ade.pfe.domain.ouvrage.OuvrageChain;
import dz.ade.pfe.port.in.exploitation.UpdatePersonnelCommand;
import dz.ade.pfe.port.out.exploitation.deletepersonnel.DeletePersonnelByIds;
import dz.ade.pfe.port.out.exploitation.getusers.LoadPersonnel;
import dz.ade.pfe.port.out.exploitation.updateouvrage.UpdateExpOuvrage;
import dz.ade.pfe.port.out.ouvrage.createouvrage.SaveOuvrage;
import dz.ade.pfe.port.out.ouvrage.getouvrage.LoadOuvrage;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.ArrayList;
import java.util.List;
import java.util.stream.Collectors;

@Service
@RequiredArgsConstructor
public class PersonnelService implements UpdatePersonnelCommand {
    private final LoadOuvrage loadOuvrage;
    private final DeletePersonnelByIds deletePersonnelByIds;
    private final UserComponent userComponent;
    private final UpdateExpOuvrage saveOuvrage;
    private final LoadPersonnel loadPersonnel;
    @Transactional
    @Override
    public Boolean updatePersonnel(UserDto users, String code) {
        Ouvrage ouvrage = loadOuvrage.getOuvrage(code);
        List<Long> ids = ouvrage.getPersonnels().stream()
                .map(ExploitationUser::getId)
                .collect(Collectors.toList());
        ouvrage.setPersonnels(new ArrayList<>());
        if(ids.size()>0)
        deletePersonnelByIds.deletePersonnelByIds(ids);
        List<String> codes = users.getUsers();
        List<ExploitationUser> list =  new ArrayList(codes.size());
        List<User> users1 = userComponent.getAllUserByUsername(codes);
        for (User user : users1) {
            list.add(new ExploitationUser(null,ouvrage , user));
        }
        ouvrage.setPersonnels(list);
        saveOuvrage.updateOuvrage(ouvrage);
        return true;
    }

    @Override
    public UserDto getPersonnel(String code) {
        UserDto userDto = new UserDto();
        List<User> users = loadPersonnel.getPersonnel(code);
        List<String> codes =  new ArrayList(users.size());
        for(User user : users)
        {
            codes.add(user.getUsername());
        }
        userDto.setUsers(codes);
        return userDto;
    }
}
