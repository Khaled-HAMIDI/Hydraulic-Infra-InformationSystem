package dz.ade.pfe.service.exploitation.updatereading;

import dz.ade.pfe.domain.ouvrage.ExploitationReading;
import dz.ade.pfe.domain.ouvrage.Ouvrage;
import dz.ade.pfe.domain.ouvrage.WorkStopTimes;
import dz.ade.pfe.port.in.exploitation.UpdateReadingCommand;
import dz.ade.pfe.port.out.exploitation.deletetimes.DeleteTimes;
import dz.ade.pfe.port.out.exploitation.loadreading.LoadReadingDetails;
import dz.ade.pfe.port.out.exploitation.savereading.SaveReading;
import dz.ade.pfe.port.out.exploitation.savereading.SaveWorkTime;
import dz.ade.pfe.port.out.ouvrage.getouvrage.LoadOuvrage;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.LocalDate;
import java.util.ArrayList;
import java.util.List;
import java.util.stream.Collectors;

@Service
@RequiredArgsConstructor
public class UpdateReadingService implements UpdateReadingCommand {
    private final ReadingUpdateMapper readingUpdateMapper;
    private final LoadReadingDetails loadReadingDetails;
    private final SaveReading saveReading;
    private final DeleteTimes deleteTimes;
    private final TimeUpdateMapper timeUpdateMapper;
    private final SaveWorkTime saveWorkTime;
    @Transactional
    @Override
    public ReadingSaveDto updateReading(ReadingSaveDto readingSaveDto, List<TimeDto> times, String code, String id) {
        if(!readingSaveDto.getDate().equals(LocalDate.now()))
            throw new RuntimeException();
        ExploitationReading reading = loadReadingDetails.loadReading(code , id);
        readingSaveDto.setTimes(times);
        readingUpdateMapper.ReadingDtoToExpReading(readingSaveDto,reading);
        List<WorkStopTimes> times1 = loadReadingDetails.loadWorkStops(id);
        List<Long> ids = times1.stream()
                .map(WorkStopTimes::getId)
                .collect(Collectors.toList());
        times1 = null;
        deleteTimes.deleteTimes(ids);
        List<WorkStopTimes> times2 = timeUpdateMapper.TimeMapperToWorkTime(times);
        List<WorkStopTimes> times3 = new ArrayList() ;
        times3 =  times2.stream().map((time)->{
            time.setOuvrage(reading.getOuvrage());
            time.setReading(reading);
            return time;
        }).collect(Collectors.toList());
        saveWorkTime.saveWorkStopTime(times3);
        return readingUpdateMapper.ExploitationToReadingDto(saveReading.saveReading(reading));
    }
}
