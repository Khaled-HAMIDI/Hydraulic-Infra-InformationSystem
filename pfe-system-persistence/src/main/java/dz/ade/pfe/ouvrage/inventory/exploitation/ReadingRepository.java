package dz.ade.pfe.ouvrage.inventory.exploitation;

import dz.ade.pfe.domain.ouvrage.ExploitationReading;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;

import java.util.List;

public interface ReadingRepository extends JpaRepository<ExploitationReading , Long> {
    List<ExploitationReading> getByOuvrageCode(String code);
    ExploitationReading getByIdAndOuvrageCode(Long id , String code);

    @Query(value = "select r.date,count(*) from pfe.exploitation_reading r WHERE r.date > current_date - interval '7' day group by r.date order by r.date asc;", nativeQuery = true)
    List<Object> ReadingNombre();
    @Query(value = "select count(*) from pfe.exploitation_reading r WHERE r.date > current_date - interval '7' day", nativeQuery = true)
    Object ReadingAllNombre();
    @Query(value = "select sum(C.taux)/count(*) taux from (select A.id,B.dure/(A.days*24 - A.stop) taux from (select ouvrage_id id,count(*) days,sum(r.programmed_stop) stop from pfe.exploitation_reading r group by ouvrage_id ) as A JOIN (select ouvrage_id id,extract(hour from sum(r.stop-r.start)) dure from pfe.work_times r group by ouvrage_id) as B on A.id = B.id )as C", nativeQuery = true)
    Object loadAvailability();
    @Query(value = "select date(r.start) date,extract(hour from sum(r.stop-r.start)) dure from pfe.work_times r  WHERE date(r.start) > current_date - interval '10' day  group by date(r.start) order by date asc", nativeQuery = true)
    List<Object> loadAvailabilityDays();
    @Query(value = "select sum(r.volume_out/r.volume_in) taux from pfe.exploitation_reading r join pfe.ouvrage o on r.ouvrage_id = o.id where o.type like 'StationTraitementNonConventionelle'", nativeQuery = true)
    Object loadSNCUse();
}
