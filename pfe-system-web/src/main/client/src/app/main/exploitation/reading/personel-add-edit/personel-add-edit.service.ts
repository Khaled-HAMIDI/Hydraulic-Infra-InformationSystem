import { Injectable } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { API } from 'config/api.config';
import { Router, ActivatedRouteSnapshot, RouterStateSnapshot, Resolve } from '@angular/router';
import { ToolsService } from '@ayams/services/tools.service';
import { Observable } from 'rxjs';
import { Personel } from './model/personel.model';
const USERS_API = API + '/users/inventory';
const READING_API = API + '/readings';
const OUVRAGES_API = API + '/ouvrages';
@Injectable({
    providedIn: 'root'
})

export class PersonelAddEditService implements Resolve<any> {
    code: string;
    constructor(private router: Router,
        private http: HttpClient,
        private toolsService: ToolsService) {
    }

    getUsers() {
        return new Promise((resolve, reject) => {
            this.http.get(USERS_API)
                .subscribe((response: any) => {
                    resolve(response);
                }, reject);
        });

    }

    get(route) {
        return new Promise((resolve, reject) => {
            this.http.get(READING_API + '/personel/' + route.params.code)
                .subscribe((response: any) => {
                    resolve(response);
                }, reject);
        });

    }

    save(usernames): Promise<any> {
         return new Promise((resolve, reject) => {
            const userDto = {
                users: usernames,
            }
            this.http.put(READING_API + '/personel/' + this.code, userDto)
                .subscribe((response: any) => {
                    resolve(response);
                }, reject);
        });
    }

    resolve(route: ActivatedRouteSnapshot, state: RouterStateSnapshot): Observable<any> | Promise<any> | any {

        return new Promise((resolve, reject) => {

            Promise.all([
                this.getUsers(),
                this.get(route)
            ]).then(
                (data) => {
                    resolve(data);
                    this.code = route.params.code;
                },
                reject
            );
        });
    }


    saveReading(personel) {
        return new Promise((resolve, reject) => {
            this.toolsService.showProgressBar();
            this.save(personel).then((responce) => {
                this.toolsService.hideProgressBar();
                if (personel.id) {
                    let msg = this.toolsService.getTranslation('ADD-EDIT.TOAST-EDIT.success.before-var')
                        + personel.name + this.toolsService.getTranslation('ADD-EDIT.TOAST-EDIT.success.after-var');
                    this.toolsService.showSuccess(msg);
                } else {
                    this.toolsService.showSuccess('ADD-EDIT.TOAST-ADD.success');
                }
                resolve(personel);
            },
                (error) => {
                    console.log(error);
                    this.toolsService.hideProgressBar();
                    if (personel.id) {
                        let msg = this.toolsService.getTranslation('ADD-EDIT.TOAST-EDIT.error.before-var')
                            + personel.name + this.toolsService.getTranslation('ADD-EDIT.TOAST-EDIT.error.after-var');
                        this.toolsService.showError(msg);
                    }
                    else {
                        this.toolsService.showError('ADD-EDIT.TOAST-ADD.error');
                    }
                })
                , reject
        });
    }

}